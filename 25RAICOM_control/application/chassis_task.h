#ifndef CHASSIS_TASK_H
#define CHASSIS_TASK_H
#include "struct_typedef.h"
#include "CAN_receive.h"
#include "gimbal_task.h"
#include "pid.h"
#include "remote_control.h"
#include "user_lib.h"

#ifndef PI
#define PI 3.14159265358979f
#endif

//in the beginning of task ,wait a time
//???????????????
#define CHASSIS_TASK_INIT_TIME 357

//the channel num of controlling vertial speed 
//????????????????
#define CHASSIS_X_CHANNEL 1
//the channel num of controlling horizontal speed
//?????????????????
#define CHASSIS_Y_CHANNEL 0

//????????????????????
#define CHASSIS_YAW_CHANNEL 4

//?????????????????????
#define CHASSIS_PITCH_CHANNEL 3

//in some mode, can use remote control to control rotation speed
//??????????????????????????????
#define CHASSIS_WZ_CHANNEL 2

//the channel of choosing chassis mode,
//???????? ?????????
#define CHASSIS_MODE_CHANNEL 0
//rocker value (max 660) change to vertial speed (m/s) 
//????????????max 660?????????????????m/s???????
#define CHASSIS_VX_RC_SEN 0.006f
//rocker value (max 660) change to horizontal speed (m/s)
//?????????????max 660??????????????????m/s???????
#define CHASSIS_VY_RC_SEN 0.006f
#define CHASSIS_V3_2006_RC_SEN 0.006f
#define CHASSIS_V3_RC_SEN 0.0016f
#define motor_damiao_RC_SEN    0.000015f
#define motor_damiao2_RC_SEN    0.000010f
#define motor_damiao1_max_angle 1.3685f
#define motor_damiao1_min_angle -4.9145f
#define motor_damiao2_max_angle 0.6351f
#define motor_damiao2_min_angle -5.6479f
#define motor_damiao3_max_angle 0.6351f
#define motor_damiao3_min_angle -5.6479f
//in following yaw angle mode, rocker value add to angle 
//???????yaw????????????yaw????max 660?????????????????
#define CHASSIS_ANGLE_Z_RC_SEN 0.000002f
//in not following yaw angle mode, rocker value change to rotation speed
//?????????????? ???????yaw????max 660????????????????????
#define CHASSIS_WZ_RC_SEN 0.01f

#define CHASSIS_ACCEL_X_NUM 0.1666666667f
#define CHASSIS_ACCEL_Y_NUM 0.3333333333f

//rocker value deadline
//???????
#define CHASSIS_RC_DEADLINE 10

#define MOTOR_SPEED_TO_CHASSIS_SPEED_VX 0.25f
#define MOTOR_SPEED_TO_CHASSIS_SPEED_VY 0.25f
#define MOTOR_SPEED_TO_CHASSIS_SPEED_WZ 0.25f


#define MOTOR_DISTANCE_TO_CENTER 0.2f

//chassis task control time  2ms
//????????????? 2ms
#define CHASSIS_CONTROL_TIME_MS 2
//chassis task control time 0.002s
//????????????? 0.002s
#define CHASSIS_CONTROL_TIME 0.002f
//chassis control frequence, no use now.
//?????????????????��????????
#define CHASSIS_CONTROL_FREQUENCE 500.0f
//chassis 3508 max motor control current
//????3508???can????????
#define MAX_MOTOR_CAN_CURRENT 16000.0f
//press the key, chassis will swing
//??????????
#define SWING_KEY KEY_PRESSED_OFFSET_CTRL
//chassi forward, back, left, right key
//?????????????????
#define CHASSIS_FRONT_KEY KEY_PRESSED_OFFSET_W
#define CHASSIS_BACK_KEY KEY_PRESSED_OFFSET_S
#define CHASSIS_LEFT_KEY KEY_PRESSED_OFFSET_A
#define CHASSIS_RIGHT_KEY KEY_PRESSED_OFFSET_D

//m3508 rmp change to chassis speed,
//m3508???????????(m/s)???????
#define M3508_MOTOR_RPM_TO_VECTOR 0.000415809748903494517209f
#define CHASSIS_MOTOR_RPM_TO_VECTOR_SEN M3508_MOTOR_RPM_TO_VECTOR

//single chassis motor max speed
//????????????????
#define MAX_WHEEL_SPEED 4.0f
//chassis forward or back max speed
//????????????????????
#define NORMAL_MAX_CHASSIS_SPEED_X 2.0f
//chassis left or right max speed
//????????????????????
#define NORMAL_MAX_CHASSIS_SPEED_Y 1.5f

#define CHASSIS_WZ_SET_SCALE 0.05f

//when chassis is not set to move, swing max angle
//?????????????????(rad)
#define SWING_NO_MOVE_ANGLE 0.7f
//when chassis is set to move, swing max angle
//?????????????????(rad)
#define SWING_MOVE_ANGLE 0.31415926535897932384626433832795f

//chassis motor speed PID
//??????????PID
#define M3505_MOTOR_SPEED_PID_KP 15000.0f
#define M3505_MOTOR_SPEED_PID_KI 10.0f
#define M3505_MOTOR_SPEED_PID_KD 0.0f
#define M3505_MOTOR_SPEED_PID_MAX_OUT MAX_MOTOR_CAN_CURRENT
#define M3505_MOTOR_SPEED_PID_MAX_IOUT 2000.0f

//chassis follow angle PID
//???????????PID
#define CHASSIS_FOLLOW_GIMBAL_PID_KP 40.0f
#define CHASSIS_FOLLOW_GIMBAL_PID_KI 0.0f
#define CHASSIS_FOLLOW_GIMBAL_PID_KD 0.0f
#define CHASSIS_FOLLOW_GIMBAL_PID_MAX_OUT 6.0f
#define CHASSIS_FOLLOW_GIMBAL_PID_MAX_IOUT 0.2f

// 激光测距容错范围
#define DIS_OFFSET 0.01f
// 激光测距各距离
#define CATCH_ADJUST_DIS 0.431f
#define CATCH1_END_CHECK_DIS 6.200f
#define CATCH2_END_CHECK_DIS 7.200f
#define MOVE_TEMP1_BACK_DIS 7.000f
#define MOVE_TEMP2_LEFT_DIS 0.963f
#define MOVE_TEMP3_LEFT_DIS 0.700f
#define MOVE_TEMP4_BACK_DIS 6.700f
#define LAY_LEFT_DIS 0.400f
#define LAY_BACK_DIS 0.300f

/* 默认设备地址 */
#define LASER_ADDR      0x80u

/* 状态机状态 */
typedef enum {
    LASER_WAIT_ADDR = 0,
    LASER_WAIT_LEN,
    LASER_WAIT_CMD,
    LASER_PAYLOAD,
    LASER_WAIT_CS
} laser_state_t;

/* 解包器句柄 */
typedef struct {
    laser_state_t state;
    uint8_t  buf[10];   /* 帧缓存：最大 10 Byte（不含 CS）*/
    uint8_t  idx;       /* 当前已收字节数 */
    uint8_t  sum;       /* 校验累加和 */
} laser_decoder_t;

typedef enum
{
    GAME_UNSTART = 0,    // 未开始
    GAME_SETUP,          // 初始化阶段
    GAME_MOVING_TO_G1,
    GAME_CATCHING1,
    GAME_MOVING_TO_G2,
    GAME_CATCHING2,
    GAME_MOVING_TO_F,
    GAME_LAYING,         // 放置阶段
    GAME_FINISHED,
    GAME_TEST_CATCHING1,
    GAME_TEST_CATCHING2,
} process_mode_e;

typedef enum
{
  CHASSIS_VECTOR_NO_MOVE,             //??????????
  CHASSIS_VECTOR_RAW,                 //???????????
  CHASSIS_VECTOR_MY_CONTROL,          //??????????????
	CHASSIS_VECTOR_AUTO_SETTING,        //????????
	CHASSIS_VECTOR_AUTO_MOVING,         //??????????
	CHASSIS_VECTOR_AUTO_FOLLOW_YAW,     //?????????????????????��??
	CHASSIS_VECTOR_AUTO_CATCH,            //????????????????
	CHASSIS_VECTOR_AUTO_LAY,             //??????????????????


} chassis_mode_e;

typedef struct
{
  const motor_measure_t *chassis_motor_measure;
  fp32 accel;
  fp32 speed;
  fp32 speed_set;
  int16_t give_current;
} chassis_motor_t;


typedef struct
{
  const RC_ctrl_t *chassis_RC;               //????????????????, the point to remote control
  const gimbal_motor_t *chassis_yaw_motor;   //will use the relative angle of yaw gimbal motor to calculate the euler angle.????????yaw????????????????????????????.
  const gimbal_motor_t *chassis_pitch_motor; //will use the relative angle of pitch gimbal motor to calculate the euler angle.????????pitch????????????????????????????
  const fp32 *chassis_INS_angle;             //the point to the euler angle of gyro sensor.???????????????????????
  chassis_mode_e chassis_mode;               //state machine. ???????????
  chassis_mode_e last_chassis_mode;          //last state machine.??????��???????
  chassis_motor_t motor_chassis[4];          //chassis motor data.??????????
  pid_type_def motor_speed_pid[4];             //motor speed PID.?????????pid
  pid_type_def chassis_angle_pid;              //follow angle PID.?????????pid

  first_order_filter_type_t chassis_cmd_slow_set_vx;  //use first order filter to slow set-point.????????????????څ?
  first_order_filter_type_t chassis_cmd_slow_set_vy;  //use first order filter to slow set-point.????????????????څ?

  fp32 vx;                          //chassis vertical speed, positive means forward,unit m/s. ??????? ??????? ????????�� m/s
  fp32 vy;                          //chassis horizontal speed, positive means letf,unit m/s.??????? ??????? ?????  ??�� m/s
  fp32 wz;                          //chassis rotation speed, positive means counterclockwise,unit rad/s.????????????????????? ??�� rad/s
  fp32 vx_set;                      //chassis set vertical speed,positive means forward,unit m/s.?????څ??? ??????? ????????�� m/s
  fp32 vy_set;                      //chassis set horizontal speed,positive means left,unit m/s.?????څ??? ??????? ?????????�� m/s
  fp32 wz_set;                      //chassis set rotation speed,positive means counterclockwise,unit rad/s.?????څ????????????????? ??�� rad/s
  fp32 chassis_relative_angle;      //the relative angle between chassis and gimbal.???????????????????�� rad
  fp32 chassis_relative_angle_set;  //the set relative angle.????????????????
  fp32 chassis_yaw_set;             

  fp32 vx_max_speed;  //max forward speed, unit m/s.????????????? ??��m/s
  fp32 vx_min_speed;  //max backward speed, unit m/s.????????????? ??��m/s
  fp32 vy_max_speed;  //max letf speed, unit m/s.?????????? ??��m/s
  fp32 vy_min_speed;  //max right speed, unit m/s.??????????? ??��m/s
  fp32 chassis_yaw;   //the yaw angle calculated by gyro sensor and gimbal motor.??????????????????yaw???
  fp32 chassis_pitch; //the pitch angle calculated by gyro sensor and gimbal motor.??????????????????pitch???
  fp32 chassis_roll;  //the roll angle calculated by gyro sensor and gimbal motor.??????????????????roll???

} chassis_move_t;


extern void chassis_task(void const *pvParameters);

extern void chassis_rc_to_control_vector(fp32 *vx_set, fp32 *vy_set, chassis_move_t *chassis_move_rc_to_vector);
extern void Motor_enable();
extern uint8_t CANx_SendStdData(CAN_HandleTypeDef *hcan, uint16_t ID, uint8_t *pData, uint16_t Len);
extern uint8_t Data_Enable[8];


uint16_t get_chassis_current(void);
#endif
